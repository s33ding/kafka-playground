apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka-s3-sink
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kafka-s3-sink
  template:
    metadata:
      labels:
        app: kafka-s3-sink
    spec:
      tolerations:
      - key: "kafka"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      nodeSelector:
        role: "kafka"
      containers:
      - name: s3-sink
        image: python:3.11-slim
        command: ["/bin/sh", "-c"]
        args:
        - |
          pip install kafka-python boto3
          python /app/s3-sink.py
        volumeMounts:
        - name: sink-code
          mountPath: /app
        env:
        - name: AWS_DEFAULT_REGION
          value: "sa-east-1"
      volumes:
      - name: sink-code
        configMap:
          name: s3-sink-code
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: s3-sink-code
data:
  s3-sink.py: |
    import json
    import boto3
    from kafka import KafkaConsumer
    from datetime import datetime
    import os

    # AWS S3 client
    s3_client = boto3.client('s3', region_name='sa-east-1')
    bucket_name = 'kafka-playground-sink-bucket'

    # Kafka consumer
    consumer = KafkaConsumer(
        'playground-topic',
        bootstrap_servers=['kafka-brokers:9092'],
        value_deserializer=lambda m: json.loads(m.decode('utf-8')),
        auto_offset_reset='earliest',
        group_id='s3-sink-consumer'
    )

    print(f"Starting S3 sink consumer for topic: playground-topic")
    print(f"Writing to S3 bucket: {bucket_name}")

    for message in consumer:
        try:
            # Create S3 key with timestamp and partition info
            timestamp = datetime.now().strftime('%Y/%m/%d/%H')
            key = f"kafka-data/{timestamp}/partition-{message.partition}/offset-{message.offset}.json"
            
            # Prepare data for S3
            data = {
                'timestamp': datetime.now().isoformat(),
                'topic': message.topic,
                'partition': message.partition,
                'offset': message.offset,
                'key': message.key.decode('utf-8') if message.key else None,
                'value': message.value
            }
            
            # Write to S3
            s3_client.put_object(
                Bucket=bucket_name,
                Key=key,
                Body=json.dumps(data),
                ContentType='application/json'
            )
            
            print(f"✅ Message written to S3: s3://{bucket_name}/{key}")
            
        except Exception as e:
            print(f"❌ Error writing to S3: {e}")
